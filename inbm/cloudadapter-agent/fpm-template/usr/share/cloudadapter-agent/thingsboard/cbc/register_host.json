{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Register Host",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "externalId": null
  },
  "metadata": {
    "firstNodeIndex": 1,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 325,
          "layoutY": 151
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if register host request",
        "debugMode": false,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return msg.method == \"registerhostver\";",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 190,
          "layoutY": 300
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if INB device",
        "debugMode": false,
        "configuration": {
          "jsScript": "return metadata.deviceType === \"INB\";"
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 635,
          "layoutY": 150
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create register host body",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var params = JSON.parse(msg.params);\nmetadata.hvs_endpoint = params[\"hvs_endpoint\"];\nmetadata.host_name = params[\"hostname\"];\nmetadata.flavor_group_name = metadata.cs_tep_flavor_group_name;\nmetadata.token = \"eyJhbGciOiJSUzM4NCIsImtpZCI6IjY0ZDQzNTUwZmVlODU0YTdlYmMzNTQ3YmU3NGIxOTJlNTExOTc3ZGYiLCJ0eXAiOiJKV1QifQ.eyJyb2xlcyI6W3sic2VydmljZSI6IkhWUyIsIm5hbWUiOiJBZG1pbmlzdHJhdG9yIn1dLCJwZXJtaXNzaW9ucyI6W3sic2VydmljZSI6IkhWUyIsInJ1bGVzIjpbIio6KjoqIl19XSwiZXhwIjoxNzU4ODk0MjYzLCJpYXQiOjE2ODY4OTQyMzMsImlzcyI6IkFBUyBKV1QgSXNzdWVyIiwibmJmIjoxNjg2ODk0MjMzLCJzdWIiOiJnbG9iYWxBZG1pblVzZXJuYW1lIn0.QOLO_JjuBdlE6MUH1GsDkx-bEiF6SGYszY6PHsLUXs23UqWDUOCga04H3DNh0UaJyUiyFDChwSMqgsWK1jRrgAswTNORrH6ZuU7LkiMLp1le3fFTAfKuq2hNSos0xfywbIkU-oexh-oYHpdWPU0_KfXhHuvz07cVBGzZ9wCXVNAkyQ9FjMennyDbOrbk32KOwkOuWmVprR4sh9uP7e6Bp3USy4RAkNBnrwpuVCKTWgRDpGT0CNRTJ7Iaozb2VUZe8p9dDS4B-qw5EzrsDnX7OoIfG1fBzP7LmRmhjMqBY2Eh_Jedg9nC2CcsVMUcSKNU1XrZlLI3AHhJC9rvtKr1wpKnDcgHb4U0MpHzU9mih7X0xBt6_sPlk-tWL1NbaQDLgKvw427eyUH0lEDsKskBEk-IK29ci749HQFUwQytPxDQszgpF8NIeMp7l65Qe4KisPpQhbtdG_M9G9VILi9x9GTrj21uPMdQzmrknvcGu6pLL-_A4OC5ijbuGPcPwnKt\";\n\n\n// if the user doesn't provide host_name, use the device name.\nif (!metadata.host_name){\n    metadata.host_name = metadata.deviceName;\n}\n\nvar body = {\n    \"connection_string\": \"intel:nats://cbc-c2w1-tgl\",\n    \"description\": \"TEP Device\",\n    \"flavorgroup_names\": [metadata.flavor_group_name],\n    \"host_name\": metadata.host_name\n};\n\nreturn {msg: body, metadata: metadata, msgType: msgType};",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 755,
          "layoutY": 301
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Register Host",
        "debugMode": true,
        "configuration": {
          "restEndpointUrlPattern": "${hvs_endpoint}/hvs/v2/hosts",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": true,
          "proxyScheme": "https",
          "proxyHost": "http://proxy-dmz.intel.com",
          "proxyPort": 912,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 20000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Accept": "application/json",
            "Authorization": "Bearer ${token}",
            "Content-Type": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1019,
          "layoutY": 295
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save tep host id",
        "debugMode": true,
        "configuration": {
          "scope": "CLIENT_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 885,
          "layoutY": 150
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Update TEP Info Attribute",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "if (!msg.attributes) {\r\n  msg.attributes = {\r\n    tep_host_id: msg.id,\r\n    tep_hostname: metadata.host_name,\r\n    hvs_endpoint: metadata.hvs_endpoint\r\n  }\r\n};\r\nmsgType = \"POST_ATTRIBUTES_REQUEST\";\r\nreturn { msg: msg.attributes, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 479,
          "layoutY": 299
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Read flavor group name from dashboard",
        "debugMode": true,
        "configuration": {
          "tellFailureIfAbsent": true,
          "fetchToData": false,
          "clientAttributeNames": [
            "tep_flavor_group_name"
          ],
          "sharedAttributeNames": [],
          "serverAttributeNames": [],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1300,
          "layoutY": 295
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save logs",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0,
          "skipLatestPersistence": false,
          "useServerTs": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1166,
          "layoutY": 153
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Add logs body",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var body = {\r\n        \"event\": {\r\n        \"logs\": \"Register host with Verifier complete. Hostname=\" + msg.tep_hostname + \", host ID=\" + msg.tep_host_id\r\n        }\r\n};\r\n\r\nmsgType = \"POST_TELEMETRY_REQUEST\";\r\nreturn { msg: body, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 6,
        "type": "True"
      },
      {
        "fromIndex": 1,
        "toIndex": 0,
        "type": "True"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 7,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}